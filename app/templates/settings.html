{% extends "base.html" %}
{% block title %}{{ tr['settings_title'] if tr else 'Settings' }} - {{ tr['app_name'] if tr else 'ChronoCam' }}{%
endblock %}
{% block content %}
<h2><i class="fa-solid fa-gear me-2"></i>{{ tr['settings_title'] if tr else 'Settings' }}</h2>
<hr class="mx-auto">
{% if request.query_params.get('saved') %}
<div id="save-alert" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
  <i class="fa-solid fa-circle-check me-2"></i>Einstellungen gespeichert
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}


<div id="settings-status" class="mt-3"></div>

<form id="settings-form" method="post" action="/update" class="mt-3"
      data-save-success="{{ tr.get('settings_saved', 'Einstellungen gespeichert') if tr else 'Einstellungen gespeichert' }}"
      data-save-error="{{ tr.get('settings_save_failed', 'Speichern fehlgeschlagen') if tr else 'Speichern fehlgeschlagen' }}">
  <!-- Main -->
  <h5 class="mb-2">{{ tr["main"] if tr else "Main" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-7">
      <label class="form-label">{{ tr["instance_name"] if tr else "Instance Name" }}</label>
      <input class="form-control" name="INSTANCE_NAME" value="{{ cfg.instance_name or '' }}" maxlength="80">
    </div>
    <div class="col-md-3 ms-md-auto">
      <label class="form-label">{{ tr['language'] if tr else 'Sprache' }}</label>
      <select class="form-select" name="LANGUAGE">
        {% for code in (langs or []) %}
        <option value="{{ code }}" {% if (lang or 'de' )==code %}selected{% endif %}>{{ tr.get(code, code) if tr else
          code }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Camera settings -->
  <h5 class="mb-2"><i class="fa-solid fa-camera me-2"></i>{{ tr["camera"] if tr else "Camera" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-10">
      <label class="form-label">{{ tr["snapshot_url"] if tr else "Snapshot URL" }}</label>
      <input class="form-control" name="CAM_URL" value="{{ cfg.cam_url }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">{{ tr["interval_seconds"] if tr else "Interval (sec)" }}</label>
      <input type="number" min="1" class="form-control" name="INTERVAL_SECONDS" value="{{ cfg.interval_seconds }}">
    </div>
    <div class="col-md-3" style="display:none;">
      <label class="form-label">{{ tr["save_path"] if tr else "Save Path" }}</label>
      <input class="form-control" name="SAVE_PATH" value="{{ cfg.save_path }}">
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Authentication -->
  <h5 class="mb-2"><i class="fa-solid fa-lock me-2"></i>{{ tr["auth"] if tr else "Authentication" }}</h5>
  <div class="row g-3 mb-3">
    <div class="col-md-2">
      <label class="form-label">{{ tr["auth_type"] if tr else "Auth Type" }}</label>
      <select class="form-select" name="AUTH_TYPE">
        <option value="none" {% if cfg.auth_type=="none" %}selected{% endif %}>{{ tr["none"] if tr else "None" }}
        </option>
        <option value="basic" {% if cfg.auth_type=="basic" %}selected{% endif %}>{{ tr["basic"] if tr else "HTTP Basic"
          }}</option>
        <option value="digest" {% if cfg.auth_type=="digest" %}selected{% endif %}>{{ tr["digest"] if tr else "HTTP
          Digest" }}</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">{{ tr["username"] if tr else "Username" }}</label>
      <input class="form-control" name="USERNAME" value="{{ cfg.username or '' }}">
    </div>
    <div class="col-md-5">
      <label class="form-label">{{ tr["password"] if tr else "Password" }}</label>
      <input type="password" class="form-control" name="PASSWORD" value="{{ cfg.password or '' }}">
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Time control -->
  <h5 class="mb-2"><i class="fa-solid fa-clock me-2"></i>{{ tr["time_control"] if tr else "Time Control" }}</h5>
  <div class="row g-3 mb-3">
    <!-- Left column: start/end time (stacked) -->
    <div class="col-md-2">
      <div class="mb-3">
        <label class="form-label">{{ tr["start_time"] if tr else "Start Time" }}</label>
        <input type="time" class="form-control" name="ACTIVE_START" value="{{ cfg.active_start }}"
          pattern="[0-9]{2}:[0-9]{2}" step="60" required>
      </div>

      <div>
        <label class="form-label">{{ tr["end_time"] if tr else "End Time" }}</label>
        <input type="time" class="form-control" name="ACTIVE_END" value="{{ cfg.active_end }}"
          pattern="[0-9]{2}:[0-9]{2}" step="60" required>
      </div>
    </div>


    
    <div class="col-md-9">
      <label class="form-label d-block">{{ tr["weekdays"] if tr else "Weekdays" }}</label>
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Mon" name="ACTIVE_DAYS" value="Mon" {% if 'Mon' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Mon">Mo</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Tue" name="ACTIVE_DAYS" value="Tue" {% if 'Tue' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Tue">Di</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Wed" name="ACTIVE_DAYS" value="Wed" {% if 'Wed' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Wed">Mi</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Thu" name="ACTIVE_DAYS" value="Thu" {% if 'Thu' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Thu">Do</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Fri" name="ACTIVE_DAYS" value="Fri" {% if 'Fri' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Fri">Fr</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Sat" name="ACTIVE_DAYS" value="Sat" {% if 'Sat' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Sat">Sa</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="day-Sun" name="ACTIVE_DAYS" value="Sun" {% if 'Sun' in
            cfg.active_days %}checked{% endif %}>
          <label class="form-check-label" for="day-Sun">So</label>
        </div>
      </div>
    </div>
  </div>
  <hr class="mx-auto">
  <!-- Astral -->
  <h5 class="mb-2"><i class="fa-solid fa-sun me-2"></i>{{ tr["astral"] if tr else "Astral (Sun times)" }}</h5>
  <div class="mb-3 form-check form-switch">
    <input class="form-check-input" type="checkbox" id="use-astral" name="USE_ASTRAL" value="true" {% if cfg.use_astral
      %}checked{% endif %}>
    <label class="form-check-label" for="use-astral">{{ tr["use_astral"] if tr else "Use sunrise/sunset" }}</label>
  </div>
  <div class="mb-2">
    <a href="https://www.latlong.net/convert-address-to-lat-long.html" target="_blank" rel="noopener noreferrer">
      <i class="fa-solid fw-7 fa-location-dot me-1"></i>{{ tr['coords_help'] if tr else 'Get coordinates from address'
      }}
    </a>
  </div>
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">{{ tr["latitude"] if tr else "Latitude" }}</label>
      <input class="form-control" name="CITY_LAT" value="{{ cfg.city_lat }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ tr["longitude"] if tr else "Longitude" }}</label>
      <input class="form-control" name="CITY_LON" value="{{ cfg.city_lon }}">
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ tr["timezone"] if tr else "Time zone" }}</label>
      <input class="form-control" name="CITY_TZ" value="{{ cfg.city_tz }}">
    </div>
  </div>
  <hr class="mx-auto">
  <div class="mt-4 text-end">
    <button class="btn btn-success px-4" type="submit"><i class="fa-solid fa-floppy-disk me-2"></i>{{ tr["save"] if tr
      else "Save" }}</button>
  </div>
</form>

<div class="mt-4 pt-3 border-top text-muted small d-flex flex-wrap gap-3 justify-content-between align-items-center">
  <div><a href="https://github.com/der-pw/chronocam2" target="_blank" rel="noopener noreferrer">{{ tr['app_name'] if tr else 'ChronoCam2' }}</a> Â· {{ app_version }}</div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='js/settings.js') }}"></script>
{% endblock %}
